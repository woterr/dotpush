name: Publish AUR Package

on:
  push:
    tags:
      - "v*"

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download GitHub source tarball
        run: |
          curl -L -o source.tar.gz \
            https://github.com/woterr/dotpush/archive/refs/tags/v${{ steps.version.outputs.VERSION }}.tar.gz

      - name: Compute sha256 checksum
        id: sha
        run: |
          SHA=$(sha256sum source.tar.gz | cut -d ' ' -f1)
          echo "SHA256=$SHA" >> $GITHUB_OUTPUT

      - name: Update PKGBUILD + Push to AUR (in Arch container)
        uses: docker://archlinux:latest
        with:
          entrypoint: /bin/bash
          args: |
            -c "
              pacman -Sy --noconfirm git openssh pacman-contrib sudo

              # Setup SSH
              mkdir -p /root/.ssh
              echo '${{ secrets.AUR_SSH_PRIVATE_KEY }}' > /root/.ssh/id_ed25519
              chmod 600 /root/.ssh/id_ed25519

              echo 'Host aur.archlinux.org
                HostName aur.archlinux.org
                User aur
                IdentityFile /root/.ssh/id_ed25519
              ' > /root/.ssh/config

              ssh-keyscan aur.archlinux.org >> /root/.ssh/known_hosts

              # Clone AUR repo
              git clone ssh://aur@aur.archlinux.org/${{ secrets.AUR_REPO }}.git /aur-repo
              cd /aur-repo

              # Update PKGBUILD
              sed -i 's/^pkgver=.*/pkgver=${{ steps.version.outputs.VERSION }}/' PKGBUILD
              sed -i 's/^sha256sums=.*/sha256sums=('"'"'${{ steps.sha.outputs.SHA256 }}'"'"')/' PKGBUILD

              makepkg --printsrcinfo > .SRCINFO

              # Commit + Push
              git config user.name '${{ secrets.AUR_USERNAME }}'
              git config user.email 'actions@github.com'
              git add PKGBUILD .SRCINFO
              git commit -m 'Update to v${{ steps.version.outputs.VERSION }}' || echo 'No changes'
              git push
            "
